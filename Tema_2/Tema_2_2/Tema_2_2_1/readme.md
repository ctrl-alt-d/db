# SQL Insercions

En aquesta secció aprendrem a inserir files en una taula amb SQL. Ens centrarem en PostgreSQL (p. ex. Supabase), tot i que la sintaxi bàsica és molt similar a d'altres SGBD.

## Sintaxi bàsica

La forma més comuna és especificar les columnes i els seus valors amb `VALUES`:

```sql
INSERT INTO taula (col1, col2, col3)
VALUES (valor1, valor2, valor3);
```

- Si s'omet la llista de columnes, s'han de proporcionar valors per a totes les columnes, i en el mateix ordre en què van ser definides.
- És recomanable indicar sempre la llista de columnes per evitar errors quan canvia l'esquema.

Exemple amb una taula `clients(id SERIAL PRIMARY KEY, nom TEXT NOT NULL, email TEXT UNIQUE, alta DATE DEFAULT CURRENT_DATE)`:

```sql
INSERT INTO clients (nom, email)
VALUES ('Anna Puig', 'anna@example.com');
```

Com que `id` és generat automàticament i `alta` té un valor per defecte, podem ometre'ls.

## Tipus de valors i literals

- Text: useu cometes simples: `'text'`. Si cal incloure una cometa simple interna, dupliqueu-la: `'L''Anna'`.
- Nombres: sense cometes: `42`, `3.14`.
- Dates/hores: `'2025-10-25'`, `'2025-10-25 14:00:00'`. PostgreSQL les interpreta segons el tipus de la columna (`DATE`, `TIMESTAMP`, …).
- `NULL`: representa valor desconegut/absent. Només és vàlid si la columna no és `NOT NULL` o si un `DEFAULT` el substitueix.
- `DEFAULT`: força l'ús del valor per defecte de la columna.

```sql
INSERT INTO clients (nom, email, alta)
VALUES ('Joan', DEFAULT, '2025-10-25');
```

## Insercions múltiples

Podeu inserir diverses files en una sola instrucció `INSERT` separant tuples de `VALUES` per comes:

```sql
INSERT INTO clients (nom, email)
VALUES
	('Marta', 'marta@example.com'),
	('Pau',   'pau@example.com'),
	('Iris',  'iris@example.com');
```

Això és més eficient que executar molts `INSERT` d'una sola fila.

## Inserir a partir d'una consulta (INSERT … SELECT)

Permet copiar o transformar dades d'una altra taula (o consulta):

```sql
INSERT INTO clients_hist (client_id, nom, email, alta)
SELECT id, nom, email, alta
FROM clients
WHERE alta < '2024-01-01';
```

També podeu combinar amb funcions o agregacions dins del `SELECT`.

## Columnes autoincrementals (IDENTITY/SERIAL)

En PostgreSQL modern, es recomana `GENERATED { ALWAYS | BY DEFAULT } AS IDENTITY`. A projectes existents també trobareu `SERIAL`.

```sql
CREATE TABLE productes (
	id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	nom TEXT NOT NULL,
	preu NUMERIC(10,2) NOT NULL
);

INSERT INTO productes (nom, preu)
VALUES ('Teclat', 24.90);
```

No cal indicar l'`id`; el SGBD l'assigna automàticament.


## Restriccions i errors habituals

- `NOT NULL violation`: heu inserit `NULL` a una columna `NOT NULL` sense `DEFAULT`.
- `UNIQUE violation` o `duplicate key value violates unique constraint`: un valor ja existeix per a una columna única o clau primària.
- `FOREIGN KEY violation`: el valor referenciat no existeix a la taula pare.
- `CHECK constraint violation`: el valor no compleix una regla definida (`preu > 0`, etc.).
- Errors de tipus: intentar inserir `'abc'` a una columna numèrica, o una data amb format invàlid.

Llegiu sempre el missatge d'error; indica la columna, la restricció i el valor problemàtic.

## Bonnes pràctiques

- Indiqueu explícitament la llista de columnes a `INSERT INTO`.

